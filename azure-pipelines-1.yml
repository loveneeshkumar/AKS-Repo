trigger:
- none

pool:
  name: love2   # self-hosted agent pool

variables:
  TF_WORKING_DIR: '$(System.DefaultWorkingDirectory)/AKS'

stages:
# ------------------ Stage 1: Validate ------------------
- stage: Validate
  displayName: "Validate Terraform Code"
  jobs:
  - job: Validate
    pool:
      name: love2
    steps:
      # Install Terraform CLI if not already installed
      - script: |
          if ! command -v terraform &> /dev/null
          then
            echo "Terraform not found. Installing..."
            curl -LO https://releases.hashicorp.com/terraform/1.7.7/terraform_1.7.7_linux_amd64.zip
            unzip terraform_1.7.7_linux_amd64.zip
            sudo mv terraform /usr/local/bin/
          else
            echo "Terraform already installed"
          fi
        displayName: "Install Terraform CLI"

      - script: terraform fmt -check
        displayName: "Terraform Format Check"
        workingDirectory: $(TF_WORKING_DIR)

      - script: terraform validate
        displayName: "Terraform Validate"
        workingDirectory: $(TF_WORKING_DIR)

# ------------------ Stage 2: Plan ------------------
- stage: Plan
  displayName: "Terraform Plan"
  dependsOn: Validate
  jobs:
  - job: Plan
    pool:
      name: love2
    steps:
      - script: terraform init
        displayName: "Terraform Init"
        workingDirectory: $(TF_WORKING_DIR)

      - script: terraform plan -out=tfplan
        displayName: "Terraform Plan"
        workingDirectory: $(TF_WORKING_DIR)
